<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/ETH Ratio Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../libs/papaparse.min.js"></script>
</head>
<body>
    <h1>BTC/ETH Ratio with SMA-100 and EMA-20</h1>
    <canvas id="btcEthChart" width="800" height="400"></canvas>
    <script>
        function calculateSMA(data, window) {
            let sma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < window - 1) {
                    sma.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < window; j++) {
                        sum += data[i - j];
                    }
                    sma.push(sum / window);
                }
            }
            return sma;
        }

        function calculateEMA(data, window) {
            let ema = [];
            let multiplier = 2 / (window + 1);
            for (let i = 0; i < data.length; i++) {
                if (i < window - 1) {
                    ema.push(null);
                } else if (i === window - 1) {
                    let sum = 0;
                    for (let j = 0; j < window; j++) {
                        sum += data[i - j];
                    }
                    ema.push(sum / window);
                } else {
                    // ema.push((data[i] - ema[i - 1]) * multiplier + ema[i - 1]);
                    ema.push(data[i] * multiplier + ema[i-1] * (1 - multiplier));
                }
            }
            return ema;
        }

        const formatDate = date => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        Papa.parse('../data/pivots.csv', {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                const data = results.data;
                const labels = data.map(row => formatDate(new Date(row['']))).slice(-100);
                const btcEthRatio = data.map(row => row['bitcoin'] / row['ethereum']).slice(-100);
                const sma100a = calculateSMA(btcEthRatio, 100);
                const sma100 = sma100a.slice(-100);
                const ema20a = calculateEMA(btcEthRatio, 20);
                const ema20 = ema20a.slice(-100);

                const ctx = document.getElementById('btcEthChart').getContext('2d');
                const btcEthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'BTC/ETH Ratio',
                                data: btcEthRatio,
                                borderColor: 'blue',
                                fill: false
                            },
                            {
                                label: 'SMA-100',
                                data: sma100,
                                borderColor: 'green',
                                fill: false
                            },
                            {
                                label: 'EMA-20',
                                data: ema20,
                                borderColor: 'red',
                                fill: false
                            }
                        ]
                    },
                });
            }
        });
    </script>
</body>
</html>
