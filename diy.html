<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pivot Protocol DIY Chart++</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css"></link>
    <link rel="stylesheet" href="aqua.css"></link>
</head>
<body>
    <center>
    <h1>Pivot Playground</h1>
     <h3>Select two assets to see if they are a good pivot pair!<br/>
       If so, DM the protocol at 
       <a href="https://x.com/pivocateur">@pivocateur</a>
     </h3>  

   <table border='1' width='85%'>
    <tr>
     <td colspan='3'>
<div class="line-container">
    <select id="token1" class="styled-select" onchange="selected(this)">
    </select>
    <select id="token2" class="styled-select"></select>
    <button class="ok-btn" onclick="go()">DIY</button>
</div>
     </td>
    </tr>
    <tr>
     <th width='15%'>Call:</th>
     <td colspan='2'><p id='recommendation'></p>
     </td>
    </tr>
    <tr>
     <td colspan='2' width="75%">
      <canvas id="pivotChart" width="800" height="400"></canvas>
     </td>
     <td width="25%">
      <table border="0">
       <tr><td>&nbsp;</td></tr>
       <tr>
<td>
<div class="aqua-container">
  <div class="field-group">
    <label for="field1">Pivot Swap</label>
  </div>
  <div class="field-group">
    <label for="field1" id="label1">Label A</label>
    <input type="text" id="field1" value="Value 1" onChange="recompute()">
    <label for="field1" id="amount1">$1000.00</label>
  </div>
  
  <div class="field-group">
    <label for="field1" id="label2">Label B</label>
    <label for="field1" id="field2">Value 2</label>
  </div>
  
  <center>
   <button id="rotateBtn" onclick="swapValues()">ðŸ”„ &nbsp; Flip</button>
  </center>
</div>
 
       </td></tr>
       <tr><td>&nbsp;</td></tr>
      </table>
     </td>
    </tr>
    <tr>
     <td colspan='3'>
      <canvas id="deltaChart" width="800" height="400"></canvas>
     </td>
    </tr>
    </tr>
   </table>
</center>

  <p style="vertical-align:bottom">
   <a href='#'
      onclick='window.top.location.href = "https://github.com/pivoteur/biz/blob/main/README.md#pivot-arbitrage";'>
Learn more <img src='imgs/leave-site.png' width='16'/></a>

about pivot arbitrage.
</p>
    <script src="libs/usd.js"></script>
    <script src="libs/indicators.js"></script>
    <script src="libs/table.js"></script>
    <script src="libs/pivots.js"></script>
    <script src="libs/canvas-bg.js"></script>
    <script src='libs/charts/line.js'></script>
    <script src="libs/charts/pivot.js"></script>
    <script src='libs/dom.js'></script>
    <script src='libs/pool-assets.js'></script>
    <script>
const swapValues = () => {
  [f1.value, f2.innerText] = [f2.innerText, f1.value];
  [l1.innerText, l2.innerText] = [l2.innerText, l1.innerText];
};

const removeOptions = selectElement => {
   var i, L = selectElement.options.length - 1;
   for(i = L; i >= 0; i--) {
      selectElement.remove(i);
   }
};

const refreshOptions = tok1 => {
   let t2 = document.getElementById('token2');
   removeOptions(t2);
   let top = prices[tok1];
   for (tok in prices) {
      if (prices[tok] < top || tok === 'USDC') {
         t2.options.add(new Option(tok, tok));
      }
   }
};

const selected = selectElement => {
   refreshOptions(selectElement.value);
};

const go = () => {
   let val1 = document.getElementById('token1').value;
   let val2 = document.getElementById('token2').value;
   location.href = "diy.html?t1=" + val1 + "&t2=" + val2;
};

let prices = {};
let [t1, t2] = Object.values(params());
  const f1 = document.getElementById('field1');
  const f2 = document.getElementById('field2');
  const l1 = document.getElementById('label1');
  const l2 = document.getElementById('label2');
  const a1 = document.getElementById('amount1');

        fetch(pivotsUrl).then(response => response.text())
                        .then(data => {
   let [table, idx] = pivotTable(data);
   let currentPrices = table[table.length - 1];
   let tag1 = document.getElementById('token1');
   let tag2 = document.getElementById('token2');
   let tokens = assets(poolAssets['assets']);
   for (const tok of Object.keys(idx)) {
      if(tokens.has(tok)) {
         tag1.options.add(new Option(tok, tok));
         prices[tok] = currentPrices[idx[tok]];
      }
   }
   let rev = pivotChartsTbl(t1, t2, table, idx);
   tag1.value = t1;
   refreshOptions(t1);
   tag2.value = t2;

   let [a, b] = [t1, t2];
   if(rev) { [b, a] = [t1, t2]; }
   l1.innerText = a;
   l2.innerText = b;
   f1.value = round(1000.0 / prices[a]);
   f2.innerText = round(1000.0 / prices[b]);
});

const recompute = () => {
   let tot = prices[l1.innerText] * f1.value;
   let tot1 = Math.round(tot * 100)/100;
   a1.innerText = "$" + tot1;
   f2.innerText = round(tot1 / prices[l2.innerText]);
};

const round = amount => {
   let fix = 2;
   if(amount < 1) { fix = 4;
   } else if(amount < 0.01) { fix = 6;
   } else if(amount > 1000) { fix = 0; }
   return amount.toFixed(fix);
};

    </script>
</body>
</html>
